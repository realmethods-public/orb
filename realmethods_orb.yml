# This code is licensed from CircleCI to the user under the MIT license. See
# https://circleci.com/orbs/registry/licensing for details.
version: 2.1

description: |
  A CircleCI Orb to invoke the realMethods Application Generation Platform to generate MVP quality applications 
  based on a single business model and one of realMethods supported technology stacks.  Model format support includes
  UML, XMI, Eclipse Model Framework, and SQL Scripts.  Supported technology stacks include Angular7, Django, Spring Boot, 
  AWS Lambda, Google Functions, ASP.NET, Spark Microweb and Struts2. Examples of models, generation YAML files, Git parameter
  files and application options files can be found at https://github.com/realmethods-public/orb.  
  
commands:

  initialize:
    description: |
      Command to initialize realMethods orb by providing your
      API token. This token is obtained from your online account 
      under User Preferences. The source for this Orb is available 
      at https://github.com/realmethods-public/orb.
    parameters:
      api-token:
        description: "A user's API token for the realMethods CLI"
        type: env_var_name

    steps:
#######################################################################
## checkout the relevant files to a directory referenced by
## ${CIRCLE_PROJECT_REPONAME}
#######################################################################
      - checkout:
          path: "~/${CIRCLE_PROJECT_REPONAME}"

      - run:
          name: Establish SUDO env variable requirement
          command: |
            if [ $EUID == 0 ]; then
              export SUDO="not-sudo-needed"
              echo not-needed
            else
              export SUDO="need-sudo"
              echo needed
            fi
      - run:
          name: echo SUDO env
          command: echo $SUDO
          
      - run:                                                    
          name: update npm
          command: 'SUDO=sudo | $SUDO npm install -g npm@latest' 

      - run:                                                    
          name: install npm-run
          command: '$SUDO npm install -g npm-run@latest'    
          
      - run:                                 
          name: install realmethods CLI
          command: '$SUDO npm install -g realmethods_cli'
          
      - run:
          name: initialize user for realmethods CLI 
          command: '$SUDO npm-run realmethods_cli init << parameters.api-token >>'

      - run: 
          name: update the apt-get package index
          command: '$SUDO apt-get update'

      - run: 
          name: install dos2unix to convert uploaded files
          command: '$SUDO apt-get install -y dos2unix'

  generate_app:
    description: |
      Command to generate an application by providing a generation YAML file, model file, 
      Git parameters in a file, and app options in a JSON file.
    parameters:
      generation-yaml-file:
        description: "YAML file containing the application generation directives"
        type: string
        default: "${GENERATION_YAML_FILE}"
      git-params-file:
        description: "YAML file containing the Git params"
        type: string
      app-options-file:
        description: "JSON file containing the application options"
        type: string
      model-identifier:
        description: "Either the realMethods system ID of previous registered model, or the path of a model file"
        type: string
        
    steps:
      
#######################################################################
## call the realmethods CLI to generate the application
#######################################################################      
      - run:
          name: Generate the application
          command: 'sudo realmethods_cli app_generate ~/${CIRCLE_PROJECT_REPONAME}/<< parameters.generation-yaml-file >> -g ~/${CIRCLE_PROJECT_REPONAME}/<< parameters.git-params-file >> -o ~/${CIRCLE_PROJECT_REPONAME}/<< parameters.app-options-file >> -m ~/${CIRCLE_PROJECT_REPONAME}/<< parameters.model-identifier >>'


  

  